
					<!-- content-wrapper -->
					<div class="col-md-10 content-wrapper expanded">
						<div class="row">
							<div class="col-md-4 ">
								<ul class="breadcrumb">
									<li><i class="fa fa-home"></i><a href="#">Home</a></li>
									<li class="active">Report Connector</li>
									<li class="active">New Report Connector</li>
								</ul>
							</div>
						</div>
						<!-- main -->
						<div class="content">
							<div class="main-header">
								<h2>New Cartesian Chart Report Connector</h2>
								<em>Creating a new report connector for Cartesian chart report</em>
							</div>
							<div class="main-content">
								<!-- WIDGET WIZARD -->
								<div class="widget">
									<div class="widget-header">
										<h3><i class="fa fa-clipboard"></i> New Cartesian Chart Report Connector Wizard</h3>
									</div>
									<div class="widget-content">
										<div class="wizard-wrapper">
											<!-- WIZARD -->
											<div id="report-connector-wizard" class="wizard">
												<!-- NAVIGATION -->
												<div id="report-connector-wizard-steps" style="overflow: hidden;">
													<ul class="steps">
														<li data-target="#step1" class="active"><span class="badge badge-info">1</span>Report Connector Name<span class="chevron"></span></li>
														<li data-target="#step2"><span class="badge">2</span>Model<span class="chevron"></span></li>
														<li data-target="#step3"><span class="badge">3</span>Configuration<span class="chevron"></span></li>
														<li data-target="#step4" class="last"><span class="badge">4</span>Create Report Connector</li>
													</ul>
												</div>
												<div class="step-content">
													<!-- STEP 1 Connector Name -->
													<div class="step-pane active" id="step1">
														<form id="form1" data-parsley-validate novalidate>
															<p>Please provide the follow details:</p>
															<div class="row">
																<div class="col-md-10">
																	<div class="form-group">
																		<label for="connectorName">Name *</label>
																		<input type="text" id="connectorName" style="width:50%;" maxlength="45" placeholder="Report Connector Name"
																			   class="form-control" data-parsley-length="[5,255]" required data-parsley-errors-container="#connectorNameError">
																		<div id="connectorNameError" class="errorMessage"></div>
																	</div>
																	<div class="form-group">
																		<label for="reportDisplayName">Report Name *</label>
																		<input type="text" id="reportDisplayName" placeholder="Report Display Name"
																			    class="form-control" data-parsley-length="[5,255]" required data-parsley-errors-container="#reportDisplayNameError">
																		<div id="reportDisplayNameError" class="errorMessage"></div>
																	</div>
																	<div class="form-group">
																		<label for="reportDisplayName">Type *</label>
																		<label class="fancy-radio">
																			<input type="radio" name="chartType" value="AREA" required
																				   data-parsley-errors-container="#chartTypeError">
																			<span><i></i><span class="fa fa-area-chart"></span>&nbsp;Area</span>
																		</label>
																		<label class="fancy-radio">
																			<input type="radio" name="chartType" value="BAR" required
																				   data-parsley-errors-container="#chartTypeError">
																			<span><i></i><span  class="fa fa-bar-chart"></span>&nbsp;Bar</span>
																		</label>
																		<label class="fancy-radio">
																			<input type="radio" name="chartType" value="COLUMN" required
																				   data-parsley-errors-container="#chartTypeError">
																			<span><i></i><span  class="fa fa-bar-chart fa-rotate-90"></span>&nbsp;Column</span>
																		</label>
																		<label class="fancy-radio">
																			<input type="radio" name="chartType" value="LINE" required
																				   data-parsley-errors-container="#chartTypeError">
																			<span><i></i><span  class="fa fa-line-chart"></span>&nbsp;Line</span>
																		</label>
																		<div id="chartTypeError" class="errorMessage"></div>
																	</div>
																</div>
															</div>
														</form>
													</div>
													<!-- END STEP 1 -->
													<!-- STEP 2 Model -->
													<div class="step-pane" id="step2">
														<form id="form2" data-parsley-validate novalidate>
															<p>Please select model source for connector</p>
															<div class="row">
																<div class="col-md-3">
																	<label for="model">Model *</label>
																	<select id="model" class="form-control" onchange="javascript:resetConfiguration();"
																	        required data-parsley-errors-container="#modelError"></select>
																	<div id="modelError" class="errorMessage"></div>
																</div>
															</div>
														</form>
													</div>
													<!-- END STEP 2 -->
													<!-- STEP 3 Configuration -->
													<div class="step-pane" id="step3">
														<form id="form3" data-parsley-validate novalidate>
															<p>Please provide the configuration details:</p>
															<div class="row">
																<div class="col-md-6">
																	<div class="form-group">
																		<label for="chartTitle">Chart Title</label>
																		<input type="text" id="chartTitle" class="form-control" placeholder="Chart Title"
																		        data-parsley-errors-container="#chartTitleError">
																		<div id="chartTitleError" class="errorMessage"></div>
																	</div>
																	<div class="form-group">
																		<div class="col-md-4" style="padding-left:0px;">
																			<div class="form-group">
																				<label for="showLegend">Show Legend</label><br>
																				<input id="showLegend" type="checkbox" checked 
																					   class="switch-small" data-on="success" data-off="danger"
																					   data-parsley-errors-container="#showLegendError">
																				<div id="showLegendError" class="errorMessage"></div>
																			</div>
																		</div>
																		<div class="col-md-8" style="padding-left:0px;">
																			<div class="form-group">
																				<label for="showDataLabel">Show Data Label</label><br>
																				<input id="showDataLabel" type="checkbox" checked 
																					   class="switch-small" data-on="success" data-off="danger"
																					   data-parsley-errors-container="#showDataLabelError">
																				<div id="showDataLabelError" class="errorMessage"></div>
																			</div>
																		</div>
																	</div>
																	<div class="form-group">
																		<div class="col-md-4" style="padding-left:0px;">
																			<div class="form-group">
																				<label for="showXAxis">Show X-Axis</label><br>
																				<input id="showXAxis" type="checkbox" checked 
																					   class="switch-small" data-on="success" data-off="danger"
																					   data-parsley-errors-container="#showXAxisError">
																				<div id="showXAxisError" class="errorMessage"></div>
																			</div>
																		</div>
																		<div class="col-md-8" style="padding-left:0px;">
																			<div class="form-group">
																				<label for="xAxisTitle">X-Axis Title</label><br>
																				<input type="text" id="xAxisTitle" class="form-control" placeholder="X-Axis Title"
																		        	   data-parsley-length="[1,45]" data-parsley-errors-container="#xAxisTitleError">
																				<div id="xAxisTitleError" class="errorMessage"></div>
																			</div>
																		</div>
																	</div>
																	<div class="form-group">
																		<div class="col-md-4" style="padding-left:0px;">
																			<div class="form-group">
																				<label for="showYAxis">Show Y-Axis</label><br>
																				<input id="showYAxis" type="checkbox" checked 
																					   class="switch-small" data-on="success" data-off="danger"
																					   data-parsley-errors-container="#showYAxisError">
																				<div id="showYAxisError" class="errorMessage"></div>
																			</div>
																		</div>
																		<div class="col-md-8" style="padding-left:0px;">
																			<div class="form-group">
																				<label for="yAxisTitle">Y-Axis Title</label><br>
																				<input type="text" id="yAxisTitle" class="form-control" placeholder="Y-Axis Title"
																		        	    data-parsley-length="[1,45]" data-parsley-errors-container="#yAxisTitleError">
																				<div id="yAxisTitleError" class="errorMessage"></div>
																			</div>
																		</div>
																	</div>
																	<div class="form-group">
																		<label for="modelDataValueField">Model Data Value Field *</label>
																		<select id="modelDataValueField" class="form-control"  
																	        required data-parsley-errors-container="#modelDataValueFieldError"></select>
																		<div id="modelDataValueFieldError" class="errorMessage"></div>
																	</div>
																	
																	<div class="form-group">
																		<label for="modelDataLabelField">Model Data Label Field *</label>
																		<select id="modelDataLabelField" class="form-control"  
																	        required data-parsley-errors-container="#modelDataLabelFieldError"></select>
																		<div id="modelDataLabelFieldError" class="errorMessage"></div>
																	</div>
																	
																	<div class="form-group">
																		<label for="modelSeriesGroupField">Model Series Group Field *</label>
																		<select id="modelSeriesGroupField" class="form-control" onchange="javascript:rebuildDataSeries();"
																	        required data-parsley-errors-container="#modelSeriesGroupFieldError"></select>
																		<div id="modelSeriesGroupFieldError" class="errorMessage"></div>
																	</div>
																	
																	<div class="form-group">
																		<label for="dataSeries">Data Series *</label>
																		<div class="series-appendable-wrapper">
																			<!-- for unique id generation -->
																			<input type="hidden" id="count" name='count' value='1'>
																			<div style="margin-bottom: 5px;">
																				<div class="col-md-5">Series</div>
																				<div class="col-md-7">Series Label</div>
																			</div>
																		</div>
																	</div>
																</div>
																<div class="col-md-6">
																	<div  style="border-style: dotted; border-width: 1px; margin:1px;">
																		<div style="text-align:right; margin: 4px 4px;">
																			<button id="previewButton" type="button" class="btn btn-default" onclick="javascript:plotChartPreview();"><i class="fa fa-eye"></i> Preview</button>
																		</div>
																		<div id="samplePreview" class="divContentCenterAlign" style="width: 90%;">
																			<div id="samplePieChartPreviewTitle" style="width: 100%; text-align: center; border-style: dotted; border-width: 1px; margin:4px;">
																				Chart Title
																			</div>
																			
																			<div id="sampleChartPreview" class="divContentCenterAlign" style="width:100%; height: 350px; margin:8px;">
																			
																			</div>																	
																		</div>
																		<div id="generatingPreview" class="divContentCenterAlign" style="width: 90%;display:none;" >
																			<div  style="width: 100%; text-align: center; height: 350px; position:relative">
																				<i class="fa fa-spinner fa-pulse fa-5x" style="position:absolute; top: 35%;"></i>
																			</div>
																		</div>
																		<div id="preview" class="divContentCenterAlign" style="width: 90%; display:none;" >
																			<div id="cartChartPreviewTitle" style="width: 100%; text-align: center; margin:4px;">
																			</div>
																			
																			<div id="cartChartPreview" class="divContentCenterAlign" style="width:100%; height: 350px; margin:8px;">
																			
																			</div>																	
																		</div>
																	</div>
																</div>
															</div>
														</form>
													</div>
													<!-- END STEP 3 -->
													<!-- STEP 4 Confirmation -->
													<div class="step-pane" id="step4">
														<form id="form4">
															<div class="row">
																<div class="col-md-6 widget-content">
																	<h4>
																		<i class="fa fa-square"></i>
																		Basic Information
																	</h4>
																	<p class="data-row">
																		<span class="data-name">Name</span>
																		<span id="finalConnectorName" class="data-value"></span>
																	</p>
																	<p class="data-row">
																		<span class="data-name">Report Name</span>
																		<span id="finalReportName" class="data-value"></span>
																	</p>
																	<p class="data-row">
																		<span class="data-name">Model</span>
																		<span id="finalModel" class="data-value"></span>
																	</p>
																	<p class="data-row">
																		<br>
																	</p>
																	
																	<h4>
																		<i class="fa fa-square"></i>
																		Chart Configuration Information
																	</h4>
																	<p class="data-row">
																		<span class="data-name">Chart Title</span>
																		<span id="finalChartTitle" class="data-value"></span>
																	</p>
																	<p class="data-row">
																		<span class="data-name">Show Data Label</span>
																		<span id="finalShowDataLabel" class="data-value"></span>
																	</p>
																	<p class="data-row">
																		<span class="data-name">Show Legend</span>
																		<span id="finalShowLegend" class="data-value"></span>
																	</p>
																	<p class="data-row">
																		<span class="data-name">Show X-Axis</span>
																		<span id="finalShowXAxis" class="data-value"></span>
																	</p>
																	<p class="data-row">
																		<span class="data-name">X-Axis Title</span>
																		<span id="finalXAxisTitle" class="data-value"></span>
																	</p>
																	<p class="data-row">
																		<span class="data-name">Show Y-Axis</span>
																		<span id="finalShowYAxis" class="data-value"></span>
																	</p>
																	<p class="data-row">
																		<span class="data-name">Y-Axis Title</span>
																		<span id="finalYAxisTitle" class="data-value"></span>
																	</p>
																	<p class="data-row">
																		<span class="data-name">Model Data Field</span>
																		<span id="finalModelDataField" class="data-value"></span>
																	</p>
																	<p class="data-row">
																		<span class="data-name">Model Data Label Field</span>
																		<span id="finalModelDataLabelField" class="data-value"></span>
																	</p>
																</div>
																<div class="col-md-6 widget-content">												
																<h4>
																	<i class="fa fa-square"></i>
																	Series
																</h4>
																<p class="data-row">
																	<table id="finalSeriesTable" class="table table-bordered table-striped">
																	</table>
																</p>
															</div>
															</div>
														</form>
													</div>
													<!-- END STEP 4 -->
												</div>
												<!-- STEP ACTION -->
												<div class="actions">
													<button type="button" class="btn btn-default btn-prev"><i class="fa fa-arrow-left"></i> Prev</button>
													<button type="button" class="btn btn-primary btn-next" data-last="Create Report Connector">Next <i class="fa fa-arrow-right"></i></button>
												</div>
												<!-- END STEP ACTION -->
											</div>
											<!-- END WIZARD -->
										</div>
									</div>
								</div>
								
							</div>
							<!-- /main-content -->
						</div>
						<!-- /main -->
					</div>
					<!-- /content-wrapper -->
				

	<script type="text/javascript">

		//AJAX functions

		var buildModelOptions = function(){
			//jquery ajax
			$.ajax({
				type: "GET",
				url: getRestServerUrl()+"/reportbay-rest/api/models",
				
				success: function(response){
					if(response){
						var models = response.models;
						
						setBezelPageParam("models", models);
						
						if(models){
							$("#model").empty();
							$("#model").append($('<option></option>'));
							var index;
							for(index = 0; index<models.length; index++){
								var model = models[index];
								
								$("#model").append($('<option></option>').val(model.id).html(model.name));
								
							}
						}
					}
				}
			});
		};
		
		var retrieveModel = function(modelId){
			console.log('retrieveModel');
			//jquery ajax
			$.ajax({
				type: "GET",
				url: getRestServerUrl()+"/reportbay-rest/api/models/"+modelId,
				
				success: function(response){
					if(response){
						var model = response;
						
						//store retrieved model
						setBezelPageParam("model", model);
						//build the drop down list of model data fields
						rebuildModelDataFieldOptions(model.attributeBindings);
						//build the data series section and drop down option
						resetDataSeries(model.attributeBindings);
						
						//reset preview
						resetPreview();
					}
				}
			});
		};
		
		function plotChartPreview(){
			//validate required field
			var parsleyForm = $('#form3').parsley();
			parsleyForm.validate();
		
			if( !parsleyForm.isValid() )
				return false;
			
			if(!validateDataSeries() )
				return false;

			$('#cartChartPreview').empty();
			$('#cartChartPreviewTitle').empty();
			
			var reportConnector = buildReportConnector();
			
			console.log('generatePreview '+JSON.stringify(reportConnector));
			
			$("#previewButton").attr('disabled','disabled');
			//jquery ajax
			$.ajax({
				type: "POST",
				url: getRestServerUrl()+"/reportbay-rest/api/reports/preview",
				data: JSON.stringify(reportConnector),
				contentType: "application/json",
				crossDomain: true,
				
				success: function(response){
					if(response){
						console.log('generatePreview success');
						var report = response.cartesianChartReport;
						
						setBezelPageParam('report',report);
						
						//chart title
						$('#cartChartPreviewTitle').append(report.title);
						
						//obtain data
						var cartData = preparePreviewData(report.chartDataSeries, reportConnector.cartesianChartTemplate.dataSeries);
						
						console.log('cartData '+JSON.stringify(cartData));

						//prepare configuration
						var configuration = preparePreviewConfiguration(report, response.type);
						
						//hide sample
						$('#samplePreview').hide();
						$('#generatingPreview').show();
						
						//plot pie
 						$.plot('#cartChartPreview', cartData, configuration);
						
						$('#generatingPreview').hide();
						//show preview
						$('#preview').show(); 
					}
				},
				complete: function(jqXHR, textStatus){
					$("#previewButton").removeAttr('disabled');
				}
			});
		}
		

		
		var createReportConnector = function(){
			
			var reportConnector = getBezelPageParam('reportConnector');
			
			//jquery ajax
			$.ajax({
				type: "POST",
				url: getRestServerUrl()+"/reportbay-rest/api/reportconnectors",
				data: JSON.stringify(reportConnector),
				contentType: "application/json",
				crossDomain: true,

				success: function(response){
					alert('New report connector has been created.');
					loadContent("reportconnector_content.html");
				},

				error: function(jqXHR, textStatus, ex){
					alert('Failed creation with error : '+textStatus+","+ex+","+jqXHR.responseText);
				}
			});
		};
		
		function retrieveCategoryAndInitDataSeries(modelId, modelSeriesGroupField){
			console.log('retrieveCategoryAndInitDataSeries :'+modelId+':'+modelSeriesGroupField);
			//jquery ajax
			$.ajax({
				type: "GET",
				url: getRestServerUrl()+"/reportbay-rest/api/models/"+modelId+"/uniquedatafield?dataField="+modelSeriesGroupField,

				success: function(response){
					var uniqueFields = response.columnValueList;
					console.log(JSON.stringify(response));
					if(uniqueFields){
						 $(".series-appendable-wrapper").append(initSeriesGroup(uniqueFields));
					}
				},

				error: function(jqXHR, textStatus, ex){
					displayAjaxError('Failed retrieve unique field with error : '+textStatus+","+ex+","+jqXHR.responseText);
				}
			});
		}

		//End AJAX functions
		
		function resetPreview(){
			$('#samplePreview').show();
			$('#generatingPreview').hide();
			$('#preview').hide();
		}
		
		function rebuildModelDataFieldOptions(modelAttrBindings){
			
			$('#modelDataValueField').empty();
			$('#modelDataValueField').append($('<option></option>'));
			
			$('#modelDataLabelField').empty();
			$('#modelDataLabelField').append($('<option></option>'));
			
			$('#modelSeriesGroupField').empty();
			$('#modelSeriesGroupField').append($('<option></option>'));
			
			if(modelAttrBindings && $.isArray(modelAttrBindings)){
				for(var index=0; index < modelAttrBindings.length; index++){
					if(isValidModelDataField(modelAttrBindings[index].typeName)){
						$('#modelDataValueField').append($('<option></option>').val(modelAttrBindings[index].alias).html(modelAttrBindings[index].alias));
					}
					$('#modelDataLabelField').append($('<option></option>').val(modelAttrBindings[index].alias).html(modelAttrBindings[index].alias));
					$('#modelSeriesGroupField').append($('<option></option>').val(modelAttrBindings[index].alias).html(modelAttrBindings[index].alias));
				}
			}
		}
		
		function resetDataSeries(){
			$wrapper = $(".series-appendable-wrapper");
			
			$wrapper.find(".series-group-appendable").remove();

			$wrapper.find('#count').val(1);
		}

		function rebuildDataSeries(){
			
			console.log('rebuildDataSeries');

			resetDataSeries();
			
			var modelId = $("#model").find(":selected").val();
			var modelSeriesGroupField = $("#modelSeriesGroupField").find(":selected").val();
			
			if(modelId && modelSeriesGroupField){
				retrieveCategoryAndInitDataSeries(modelId, modelSeriesGroupField);
			}
		}
		
		
		function initSeriesGroup(uniqueFields){

 			var seriesGroupAppendableDiv = createElement('div',
														 {class : "series-group-appendable col-md-12", 
												   		  id:"series-group-appendable1"});
			//1. select drop down field
			var seriesGroupDiv = createElement('div',
										 	   {class: "col-md-5",
												style: "padding-left:0px; margin-bottom: 5px;"});
			
			var selectElement = createElement('select',
										      {id : "seriesGroup1",
											   name: "seriesGroup1",
											   class: "form-control",
											   'data-parsley-errors-container': "#seriesGroup1Error"
											   });

			if(uniqueFields && $.isArray(uniqueFields)){
				$(selectElement).append($('<option></option>'));
				for(var index=0; index < uniqueFields.length; index++){
					$(selectElement).append($('<option></option>').val(uniqueFields[index]).html(uniqueFields[index]));
				}
			}

			$(seriesGroupDiv).append(selectElement);
			$(seriesGroupDiv).append(createElement('div',
												   {id:"seriesGroup1Error",
					 								class:"errorMessage seriesGroupError"}));
			$(seriesGroupAppendableDiv).append(seriesGroupDiv);

			//2. input field
			var seriesGroupName = createElement('div',
				 	   							{class: "col-md-6",
												 style: "padding-left:0px; margin-bottom: 5px;"
												 });
			
			var inputTextElement = createElement('input',
												 {type:"text",
												  id:"seriesGroupName1",
												  name:"seriesGroupName1",
												  class:"form-control",
												  'data-parsley-errors-container': "#seriesGroupName1Error"
												 });
			$(seriesGroupName).append(inputTextElement);
			$(seriesGroupName).append(createElement('div',
					 								{id:"seriesGroupName1Error",
				  									 class:"errorMessage seriesGroupNameError"}));
			$(seriesGroupAppendableDiv).append(seriesGroupName);

			//3. button
			$(seriesGroupAppendableDiv).append(createAddDataSeriesDiv());
			
			return seriesGroupAppendableDiv;
 		}
		
		function createAddDataSeriesDiv(){
			
			var addDataSeriesDiv = createElement('div',
												 {class:"col-md-1"});
							
			var addDataSeriesSpan = createElement('span',
								  {style:"width: 34px; margin-bottom: 5px;"});
			$(addDataSeriesDiv).append(addDataSeriesSpan);
			
			var addDataSeriesButton = createElement('button',
									{type:"button",
									 id:"btn1",
									 class:"btn btn-primary add-series"});
			
			$(addDataSeriesButton).text('+');
							
			$(addDataSeriesSpan).append(addDataSeriesButton);
			
			$(addDataSeriesButton).click(function(){
					handleAddDataSeriesEvent($(this));
			});
			
			return addDataSeriesDiv;
		}
		
		function handleAddDataSeriesEvent(refElement){
			//lookup parent with class "series-appendable-wrapper"
			$wrapper = $(refElement).parents('.series-appendable-wrapper');
			
			//find the last child item with class "series=group-appendable" from wrapper
			$lastItem = $wrapper.find('.series-group-appendable').last(); 
			
			//clone as new item
			$newInput = $lastItem.clone();

			// change attribute for new item
			$count = $wrapper.find('#count').val();
			$count++;
			
			// change id of cloned item
			$newInput.attr('id', 'series-group-appendable' + $count);
			
			// change the text input id and name
			$newInput.find('input[type="text"]').attr({
				id: "seriesGroupName" + $count,
				name: "seriesGroupName" + $count,
				'data-parsley-errors-container': "#seriesGroupName"+ $count+"Error"
			});
			$newInput.find('input[type="text"]').removeAttr('data-parsley-id');
			$newInput.find('input[type="text"]').val('');
			
			$newInput.find('.seriesGroupNameError').attr({id: "seriesGroupName"+ $count+"Error"});
			$newInput.find('.seriesGroupNameError').empty();
			
			//change the select id and name
			$newInput.find('select').attr({
				id: "seriesGroup" + $count,
				name: "seriesGroup" + $count,
				'data-parsley-errors-container': "#seriesGroup"+ $count+"Error",
			});
			
			$newInput.find('select').removeAttr('data-parsley-id');
			
			$newInput.find('.seriesGroupError').attr({id: "seriesGroup"+ $count+"Error"});
			$newInput.find('.seriesGroupError').empty();
			
			//clear selected value
			$newInput.find('select').prop('selectedIndex',0);
			
			//update button id
			$newInput.find('.btn').attr('id', 'btn' + $count);
			$newInput.appendTo($wrapper);
			
			$newInput.find('.btn').click(function(){
				handleAddDataSeriesEvent($(this));
			});
			
			//change the previous button to remove
			$lastItem.find('.btn')
					 .removeClass('add-series btn-primary')
					 .addClass('btn-danger')
					 .text('-')
					 .off()
					 .on('click', function(){
						$(this).parents('.series-group-appendable').remove();
					 });
			
			$wrapper.find('#count').val($count);
		}
		// create html element by type and attributes
		function createElement(elementType, attributes){
			var element = document.createElement(elementType);
			
			if(attributes){
				$(element).attr(attributes);
			}
			
			return element;
		}
		
		
		function isValidModelDataField(modelFieldType){
			var isValid = false;
			
			if(modelFieldType){
				switch(modelFieldType){
					case 'BIGINT':
					case 'DECIMAL':
					case 'DOUBLE':
					case 'FLOAT':
					case 'INTEGER' :
					case 'NUMERIC' :
					case 'REAL' :
					case 'SMALLINT' :
					case 'TINYINT' :
						isValid = true;
						break;
				}
			}
			return isValid;
		}
		
		function resetConfiguration(){
			//clear model, so it trigger reload
			setBezelPageParam("model", undefined);
		}
		
		function clearRadio(){
			$('input[name="pieChartDataFormat"]').prop('checked', false);
		}
		
		function updateConfirmationDetail(){
			
			clearConfirmationDetail();
			
			var reportConnector = getBezelPageParam('reportConnector');
			
			if(reportConnector && reportConnector.cartesianChartTemplate){
				
				var cartesianChartTemplate = reportConnector.cartesianChartTemplate;
				
				console.log(JSON.stringify(cartesianChartTemplate));
				
				$("#finalConnectorName").append(cartesianChartTemplate.templateName);
				$("#finalReportName").append(cartesianChartTemplate.reportDisplayName);
				$("#finalModel").append($("#model").find(":selected").text());
				
				//chart configuration
				$("#finalChartTitle").append(cartesianChartTemplate.title);
				
				var showDataLabel = "No";
				
				if(cartesianChartTemplate.showDataLabel){
					showDataLabel = "Yes";
				}
				$("#finalShowDataLabel").append(showDataLabel);
				
				var showLegend = "No";
				
				if(cartesianChartTemplate.showLegend){
					showLegend = "Yes";
				}
				$("#finalShowLegend").append(showLegend);

				var showXAxis = "No";
				
				if(cartesianChartTemplate.showXAxis){
					showXAxis = "Yes";
				}
				$("#finalShowXAxis").append(showXAxis);
				
				$("#finalXAxisTitle").append(cartesianChartTemplate.xaxisTitle);
				
				var showYAxis = "No";
				
				if(cartesianChartTemplate.showYAxis){
					showYAxis = "Yes";
				}
				$("#finalShowYAxis").append(showYAxis);
				
				$("#finalYAxisTitle").append(cartesianChartTemplate.yaxisTitle);
				
				$("#finalModelDataField").append(cartesianChartTemplate.modelDataValueField);
				$("#finalModelDataLabelField").append(cartesianChartTemplate.modelDataLabelField);
				
				$('#finalSeriesTable').empty();
			
				var seriesTab = $('#finalSeriesTable').DataTable({
					"destroy": true,
					paging : false,
					searching : false,
					ordering: false,
					info:false,
					"columns" : [
									{"title":"Model Series Name", data:null, render: "modelSeriesName"},
									{"title":"Series Display Name", data:null, render: "seriesDisplayName"}]
				});
				
				var dataSeries = cartesianChartTemplate.dataSeries;

				if(dataSeries){
					for(index = 0; index<dataSeries.length; index++){
						seriesTab.row.add(new SeriesRow(dataSeries[index].modelSeriesValue,dataSeries[index].name));
					}
					
					seriesTab.draw();
				}
			}
		}
		
		function SeriesRow(modelSeriesName, seriesDisplayName){
			this._modelSeriesName = modelSeriesName;
			this._seriesDisplayName = seriesDisplayName;
			
			this.modelSeriesName = function(){
				return this._modelSeriesName;
			};
			this.seriesDisplayName = function(){
				return this._seriesDisplayName;
			};
		}
		
		function clearConfirmationDetail(){
			$(".data-row .data-value").empty();
		}
		
		function disableWizardStep(){
			var $steps = $('#report-connector-wizard').find('.steps li');
			$steps.removeClass('active').removeClass('complete');
			$steps.find('span.badge').removeClass('badge-info').removeClass('badge-success');
			
			$('.wizard-wrapper .btn-next').attr('disabled','disabled');
			$('.wizard-wrapper .btn-prev').attr('disabled','disabled');
		}
		
		function plotSampleChart(chartType){
			
			$('#sampleChartPreview').empty();
			
			var seriesData = getSampleSeriesByChartType(chartType);
			
			var configuration = getSampleConfigByChartType(chartType);
			
			console.log("ploting sample chart "+chartType);

			$.plot('#sampleChartPreview', seriesData, configuration);
		}
		
		function getSampleSeriesByChartType(chartType){
			var seriesData = new Array();
			
			if(chartType){
				switch(chartType){
					case 'AREA':
					case 'LINE':
						seriesData = [
										{
											data: [[1,10],[2,50],[3,40],[4,80]],
											label: "Series 1",
											lines: {
												show: true,
												lineWidth: 2,
												fill: true,
											},
											points: {
												show: true, 
												lineWidth: 3,
												fill: true,
												fillColor: '#adadad'
											}
										}
									];
						break;
					case 'BAR':
						seriesData = [
										{
											data: [[1,10],[2,50],[3,40],[4,80]],
											label: "Series 1"
										}
									];
						break;
					case 'COLUMN':
						seriesData = [
										{
											data: [[5,10],[2,20],[1,30],[4,40]],
											label: "Series 1"
										}
									];
						break;
				}
				
				if('LINE' == chartType){
					seriesData[0].lines.fill = false;
				}
			}
			
			
			return seriesData;
		}
		
		function getSampleConfigByChartType(chartType){
			
			var configuration = {};
			
			if(chartType){
				switch(chartType){
					case 'AREA':
					case 'LINE':
						configuration['series'] ={
							lines: {
								lineWidth: 2,
								fillColor: { colors: [ { opacity: 0.4 }, { opacity: 0.4 } ] }
							},
							points: {
								lineWidth: 3,
							},
	
							shadowSize: 0
						};
						
						break;
					case 'BAR':
					case 'COLUMN':
						configuration['series'] ={
								bars:{
										show : true,
										fill : true,
										lineWidth: 0,
										order: true,
										barWidth: 0.8,
										align: 'center'
								}
							};
						configuration['xaxis'] = {autoscaleMargin: '0.2'};
						break;
				}

				configuration['grid']= {
						hoverable: true, 
						clickable: true,
						borderWidth: 0,
						tickColor: "#E4E4E4"
					};
				configuration['colors'] = ["#adadad"];
				configuration['tooltip'] = {show: true, content: "%s | X: %x | Y: %y"};
				configuration['xaxes']=[{axisLabel: 'X-Axis Title', axisLabelPadding: 15}];
				configuration['yaxes']=[{position : 'left', axisLabel: 'Y-Axis Title'}];
				configuration.series['valueLabels']= {show: true};
				
				if('COLUMN' == chartType){
					configuration.series.bars['horizontal'] = true;
					configuration.series.bars.barWidth = 8;
					configuration.series.valueLabels['align']='center';
				}
			}
			
			
			return configuration;
			
		}
		
		function preparePreviewData(chartDataSeries, connectorSeries){
			
			var previewData = new Array();
			
			$.each(connectorSeries, function(index, conSeries){
				var series = {label: conSeries.name,
						 	  data : []};
				//added each series into preview data
			    previewData.push(series);
				
				for(var dIndex=0; dIndex < chartDataSeries.length; dIndex++){
					var chartSeries = chartDataSeries[dIndex];
					console.log(chartSeries.seriesName+":"+conSeries.name);
					if(chartSeries.seriesName == conSeries.name){
						
						var refSeries = chartDataSeries.splice(dIndex,1)[0];
						
						console.log(JSON.stringify(refSeries));
						
						for (var key in refSeries.seriesData) {
							//only process non prototype
							if (refSeries.seriesData.hasOwnProperty(key)) {

							    series.data.push([key, refSeries.seriesData[key]]);
							}
						}

						break;
					}
				}
			});
			
			return previewData; 
		}
		
		function buildReportConnector(){
			var connector = {};

			connector['type']= $('input[name="chartType"]:checked', '#form1').val();;
			connector['cartesianChartTemplate'] = buildCartChartConnector();
			connector['pieChartTemplate'] = undefined;
			connector['crossTabTemplate'] = undefined;
			
			return connector;
		}
		
		function buildCartChartConnector(){
			var cartChartConnector = {};

			cartChartConnector['id']			    = '0';
			cartChartConnector['modelId']		    = $("#model").find(":selected").val();
			cartChartConnector['reportDisplayName'] = $("#reportDisplayName").val();
			cartChartConnector['reportQuery']	    = undefined;
			cartChartConnector['templateName']	    = $("#connectorName").val();
			cartChartConnector['reportTemplateType']= 'SIMPLE';
			cartChartConnector['title']			    = $('#chartTitle').val();
			cartChartConnector['showLegend']		= $('#showLegend').prop('checked');
			cartChartConnector['showDataLabel']	    = $('#showDataLabel').prop('checked');
			cartChartConnector['showXAxis']	    	= $('#showXAxis').prop('checked');
			cartChartConnector['xaxisTitle']	    = $('#xAxisTitle').val();
			cartChartConnector['showYAxis']	    	= $('#showYAxis').prop('checked');
			cartChartConnector['yaxisTitle']	    = $('#yAxisTitle').val();
			cartChartConnector['modelDataValueField']= $('#modelDataValueField').find(":selected").val();
			cartChartConnector['modelDataLabelField']= $('#modelDataLabelField').find(":selected").val();
			cartChartConnector['modelSeriesGroupField']= $('#modelSeriesGroupField').find(":selected").val();

			cartChartConnector['dataSeries'] = [];
			
			$.each($('.series-appendable-wrapper').find('.series-group-appendable'), function(index, element){
				var seriesGroup = $(element).find('select :selected').val();
				var seriesGroupName = $(element).find('input[type="text"]').val();
				
				cartChartConnector.dataSeries.push({ id:'0', 
													 name: seriesGroupName, 
													 modelSeriesValue: seriesGroup});
			});
			
			return cartChartConnector;
		}
		
		function preparePreviewConfiguration(report, chartType){
			
			var configuration = {};
			
			if(chartType){
				configuration['xaxis'] = { mode: "categories" };
				var isArea = false;

				switch(chartType){
					case 'AREA':
						isArea = true;
					case 'LINE':
						
						configuration['series'] ={
							lines: {
								show: true,
								lineWidth: 2,
								fillColor: { colors: [ { opacity: 0.4 }, { opacity: 0.4 } ] },
								fill : isArea
							},
							points: {
								lineWidth: 3,
							},
	
							shadowSize: 0
						};
						
						break;
					case 'BAR':
					case 'COLUMN':
						configuration['series'] ={
								bars:{
										show : true,
										fill : true,
										lineWidth: 0,
										order: true,
										barWidth: 0.8,
										align: 'center'
								}
							};
						configuration.xaxis['autoscaleMargin'] = '0.2';
						break;
				}

				configuration['grid']= {
						hoverable: true, 
						clickable: true,
						borderWidth: 0,
						tickColor: "#E4E4E4"
					};
				configuration['colors'] = [ "#5399D6", "#d9d9d9", "#d7ea2b"];
				configuration['tooltip'] = {show: true, content: "%s | X: %x | Y: %y"};
				
				
				configuration['legend'] = {show: report.showLegend};
				
				if(report.showXAxis && report.xaxisTitle){
					configuration['xaxes']=[{axisLabel:report.xaxisTitle, axisLabelPadding: 15}];
				}
				
				if(report.showYAxis && report.yaxisTitle){
					configuration['yaxes']=[{axisLabel: report.yaxisTitle, position : 'left'}];	
				}
				
				if(report.showDataLabel){
					configuration.series['valueLabels']= {show: report.showDataLabel};
					
					if('COLUMN' == chartType){
						configuration.series.valueLabels['align']='center';
					}
				}
				
				if('COLUMN' == chartType){
					configuration.series.bars['horizontal'] = true;
					configuration.series.bars.barWidth = 8;
				}
			}
			
			return configuration;
			
		}
		
		function validateDataSeries(){
			
			var isValid = true;
			//clear all error message
			$("#form3").parsley().reset();

			$wrapper = $(".series-appendable-wrapper");
			
			$.each($wrapper.find('select'), function(index, element){
				console.log($(element).attr('id'));
				var inputTextValue = $(element).find(":selected").val();
				
				if(inputTextValue ==undefined || inputTextValue.replace(/^\s+|\s+$/gm,'') == ''){
					var failedInput = $(element).parsley();
					
					isValid = false; 
					
					//create custom parsley error message for affected field
					window.ParsleyUI.addError(failedInput,$(element).attr('id')+'Error', "This field is required");
				}
			});
			//all text fields
			$.each($wrapper.find('input[type="text"]'), function(index, element){
				console.log($(element).attr('id'));
				var inputTextValue = $(element).val();
				
				if(inputTextValue ==undefined || inputTextValue.replace(/^\s+|\s+$/gm,'') == ''){
					var failedInput = $(element).parsley();
					
					isValid = false; 

					//create custom parsley error message for affected field
					window.ParsleyUI.addError(failedInput,$(element).attr('id')+'Error', "This field is required");
				}
			});
			
			return isValid;
		}
		
		$(document).ready(function(){
			
			//clear page context before start
			initBezelParamMap();
			
			//model wizard function
			$('#report-connector-wizard').on('change', function(e, data) {
				
				//if changes from step button
				if(data && data.step){
					// validation
					if( $('#form'+data.step).length > 0 && data.direction == 'next') {
						var parsleyForm = $('#form'+data.step).parsley();
						parsleyForm.validate();
		
						if( !parsleyForm.isValid() )
							return false;
					}
		
					// last step button
					$btnNext = $(this).parents('.wizard-wrapper').find('.btn-next');
					
					var models = getBezelPageParam("models");
					var attributeMaps = getBezelPageParam("attributeMaps");
					var model = getBezelPageParam("model");
					
					//when next at step 1, based on type select prepare the sample chart
					if(data.step === 1 && data.direction == 'next'){
						var chartType= $('input[name="chartType"]:checked', '#form1').val();
						
						var sampleChartType = getBezelPageParam('chartType');
						
						if(chartType != sampleChartType){
							
							setBezelPageParam('chartType',chartType);
							plotSampleChart(chartType);
						}
					}
		
					if(data.step === 1 && data.direction == 'next' && !models){
						buildModelOptions();
					}
					else if(data.step === 2 && data.direction == 'next' && !model) {
						//obtain selected model id
						var modelId = $("#model").find(":selected").val();
						
						clearRadio();
						retrieveModel(modelId);
					}
					else if(data.step === 3 && data.direction == 'next') {
						
						//if failed data series validation
						if(!validateDataSeries())
							return false;
	
 						var reportConnector = buildReportConnector();
	
						setBezelPageParam("reportConnector", reportConnector);
						updateConfirmationDetail();
 					}
				}
	
			}).on('finished', function(){
				disableWizardStep();
				createReportConnector();
			});
			
			//render switch
			$('.form-group .switch-small').bootstrapSwitch();
			
		});

	</script>

