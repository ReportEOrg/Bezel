<!DOCTYPE html>
<!--[if IE 9 ]><html class="ie ie9" lang="en" class="no-js"> <![endif]-->
<!--[if !(IE)]><!-->
<html lang="en" class="no-js">
<!--<![endif]-->

<head>
	<title>ReportBay</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="description" content="ReportBay">
	<meta name="author" content="ReportBay Dev Team">

	<!-- CSS -->
	<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link href="../../assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	<link href="../../assets/css/main.css" rel="stylesheet" type="text/css">
	<link href="../../assets/css/my-custom-styles.css" rel="stylesheet" type="text/css">
	
	<!-- added code to apply skin -->
	<link href="../../assets/css/skins/teal.css" rel="stylesheet" type="text/css">
	<!-- end added code to apply skin -->

	<!--[if lte IE 9]>
		<link href="assets/css/main-ie.css" rel="stylesheet" type="text/css"/>
		<link href="assets/css/main-ie-part2.css" rel="stylesheet" type="text/css"/>
	<![endif]-->

	<!-- CSS for demo style switcher. you can remove this -->
	<link href="../../demo-style-switcher/assets/css/style-switcher.css" rel="stylesheet" type="text/css">

	<!-- Fav and touch icons -->
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../assets/ico/kingadmin-favicon144x144.png">
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../assets/ico/kingadmin-favicon114x114.png">
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../assets/ico/kingadmin-favicon72x72.png">
	<link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../assets/ico/kingadmin-favicon57x57.png">
	<!-- <link rel="shortcut icon" href="assets/ico/favicon.png"> -->
	<!-- <link rel="shortcut icon" href="assets/ico/reportbay.gif"> -->
	<link rel="shortcut icon" type="image/x-icon" href="../../assets/ico/reportbay2.ico">
</head>

<body class="comp-wizard">
	<!-- WRAPPER -->
	<div class="wrapper">
		<!-- TOP BAR -->
		<div class="top-bar">
			<div class="container">
				<div class="row">
					<!-- logo -->
					<div class="col-md-2 logo fa fa-clipboard" style="color:white;">
						<a href="../dashboard/dashboard.html"><span style="font-size: medium; color: white;font-family: 'latolight'; font-weight: bolder;">ReportBay</span></a>
						<h1 class="sr-only">Report Bay</h1>
					</div>
					<!-- end logo -->
					<div class="col-md-10">
						<div class="row">
							<div class="col-md-3">
								<!-- search box -->
								<div id="tour-searchbox" class="input-group searchbox">
									<input type="search" class="form-control" placeholder="enter keyword here...">
									<span class="input-group-btn">
										<button class="btn btn-default" type="button"><i class="fa fa-search"></i></button>
									</span>
								</div>
								<!-- end search box -->
							</div>
							<div class="col-md-9">
								<div class="top-bar-right">
									<!-- responsive menu bar icon -->
									<a href="#" class="hidden-md hidden-lg main-nav-toggle"><i class="fa fa-bars"></i></a>
									<!-- end responsive menu bar icon -->
									<div class="notifications">
										<ul>
											<!-- notification: inbox -->
											<li class="notification-item inbox">
												<div class="btn-group">
													<a href="#" class="dropdown-toggle" data-toggle="dropdown">
														<i class="fa fa-envelope"></i><span class="count">2</span>
														<span class="circle"></span>
													</a>
													<ul class="dropdown-menu" role="menu">
														<li class="notification-header">
															<em>You have 2 unread messages</em>
														</li>
														<li class="inbox-item clearfix">
															<a href="#">
																<div class="media">
																	<div class="media-left">
																		<img class="media-object" src="../../assets/img/user1.png" alt="Antonio">
																	</div>
																	<div class="media-body">
																		<h5 class="media-heading name">Antonius</h5>
																		<p class="text">The problem just happened this morning. I can't see ...</p>
																		<span class="timestamp">4 minutes ago</span>
																	</div>
																</div>
															</a>
														</li>
														<li class="inbox-item unread clearfix">
															<a href="#">
																<div class="media">
																	<div class="media-left">
																		<img class="media-object" src="../../assets/img/user2.png" alt="Antonio">
																	</div>
																	<div class="media-body">
																		<h5 class="media-heading name">Michael</h5>
																		<p class="text">Hey dude, cool theme!</p>
																		<span class="timestamp">2 hours ago</span>
																	</div>
																</div>
															</a>
														</li>
														<li class="notification-footer">
															<a href="#">View All Messages</a>
														</li>
													</ul>
												</div>
											</li>
											<!-- end notification: inbox -->
											<!-- notification: general -->
											<li class="notification-item general">
												<div class="btn-group">
													<a href="#" class="dropdown-toggle" data-toggle="dropdown">
														<i class="fa fa-bell"></i><span class="count">8</span>
														<span class="circle"></span>
													</a>
													<ul class="dropdown-menu" role="menu">
														<li class="notification-header">
															<em>You have 8 notifications</em>
														</li>
														<li>
															<a href="#">
																<i class="fa fa-clipboard green-font"></i>
																<span class="text">New report connector created</span>
																<span class="timestamp">1 minute ago</span>
															</a>
														</li>
														<li>
															<a href="#">
																<i class="fa fa-user green-font"></i>
																<span class="text">New registered user</span>
																<span class="timestamp">12 minutes ago</span>
															</a>
														</li>
														<li>
															<a href="#">
																<i class="fa fa-table green-font"></i>
																<span class="text">New model created</span>
																<span class="timestamp">18 minutes ago</span>
															</a>
														</li>
														<li>
															<a href="#">
																<i class="fa fa-table red-font"></i>
																<span class="text">A model is deleted</span>
																<span class="timestamp">4 hours ago</span>
															</a>
														</li>
														<li>
															<a href="#">
																<i class="fa fa-table yellow-font"></i>
																<span class="text">A model is modified</span>
																<span class="timestamp">1 day ago</span>
															</a>
														</li>
														<li>
															<a href="#">
																<i class="fa fa-table green-font"></i>
																<span class="text">New model created</span>
																<span class="timestamp">3 days ago</span>
															</a>
														</li>
														<li>
															<a href="#">
																<i class="fa fa-database green-font"></i>
																<span class="text">New datasource available!</span>
																<span class="timestamp">Oct 15</span>
															</a>
														</li>
														<li>
															<a href="#">
																<i class="fa fa-database green-font"></i>
																<span class="text">New datasource available!</span>
																<span class="timestamp">Oct 11</span>
															</a>
														</li>
														<li class="notification-footer">
															<a href="#">View All Notifications</a>
														</li>
													</ul>
												</div>
											</li>
											<!-- end notification: general -->
										</ul>
									</div>
									<!-- logged user and the menu -->
									<div class="logged-user">
										<div class="btn-group">
											<a href="#" class="btn btn-link dropdown-toggle" data-toggle="dropdown">
												<span class="fa fa-user"></span>
												<span class="name">Ramesh, Rajaram</span> <span class="caret"></span>
											</a>
											<ul class="dropdown-menu" role="menu">
												<li>
													<a href="#">
														<i class="fa fa-user"></i>
														<span class="text">Profile</span>
													</a>
												</li>
												<li>
													<a href="#">
														<i class="fa fa-cog"></i>
														<span class="text">Settings</span>
													</a>
												</li>
												<li>
													<a href="#">
														<i class="fa fa-power-off"></i>
														<span class="text">Logout</span>
													</a>
												</li>
											</ul>
										</div>
									</div>
									<!-- end logged user and the menu -->
								</div>
								<!-- /top-bar-right -->
							</div>
						</div>
						<!-- /row -->
					</div>
				</div>
				<!-- /row -->
			</div>
			<!-- /container -->
		</div>
		<!-- /top -->
		<!-- BOTTOM: LEFT NAV AND RIGHT MAIN CONTENT -->
		<div class="bottom">
			<div class="container">
				<div class="row">
					<!-- left sidebar -->
					<div class="col-md-2 left-sidebar minified">
						<!-- main-nav -->
						<nav class="main-nav">
							<ul class="main-menu">
								<li>
									<a href="../dashboard/dashboard.html">
										<i class="fa fa-dashboard fa-fw"></i><span class="text" style="opacity:0;">Dashboard</span>
									</a>
								</li>
								<li>
									<a href="#">
										<i class="fa fa-database fa-fw"></i><span class="text" style="opacity:0;">Data Source</span>
									</a>
								</li>
								<li>
									<a href="#" class="js-sub-menu-toggle active">
										<i class="fa fa-table fa-fw"></i><span class="text" style="opacity:0;">Model</span>
										<i class="toggle-icon fa fa-angle-down"></i>
									</a>
									<ul class="sub-menu ">
										<li ><a href="../model/model.html"><span class="text">Manage Model</span></a></li>
										<li class="active"><a href="../model/model_wizard_simple_table.html"><span class="text">New Simple Table Model</span></a></li>
										<li ><a href="../model/model_wizard_joined_query.html"><span class="text">New Joined Query Model</span></a></li>
									</ul>
								</li>
								<li>
									<a href="#">
										<i class="fa fa-clipboard fw"></i><span class="text" style="opacity:0;">Report Connector</span>
									</a>
								</li>
								<li>
									<a href="#">
										<i class="fa fa-bar-chart fw"></i><span class="text" style="opacity:0;">Browse Report</span>
									</a>
								</li>
							</ul>
						</nav>
						<!-- /main-nav -->
						<div class="sidebar-minified js-toggle-minified">
							<i class="fa fa-angle-left fa-angle-right"></i>
						</div>
						<!-- sidebar content -->
						<div class="sidebar-content">
							<div class="panel panel-default">
								<div class="panel-heading">
									<h5><i class="fa fa-lightbulb-o"></i> Tips</h5>
								</div>
								<div class="panel-body">
									<p>You can do live search to the widget at search box located at top bar. It's very useful if your dashboard is full of widget.</p>
								</div>
							</div>
							<h5 class="label label-default"><i class="fa fa-info-circle"></i> Usage Info</h5>
							<ul class="list-unstyled list-info-sidebar bottom-30px">
								<li class="data-row">
									<div class="data-name">Datasource Usage</div>
									<div class="data-value">
										2 / 5 
										<div class="progress progress-xs">
											<div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
												<span class="sr-only">40%</span>
											</div>
										</div>
									</div>
								</li>
								<li class="data-row">
									<div class="data-name">Model Usage</div>
									<div class="data-value">
										2 / 20 
										<div class="progress progress-xs">
											<div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100" style="width: 10%">
												<span class="sr-only">10%</span>
											</div>
										</div>
									</div>
								</li>
								<li class="data-row">
									<span class="data-name">Report Connector Usage</span>
									<span class="data-value">
										10 / 50 
										<div class="progress progress-xs">
											<div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" style="width: 20%">
												<span class="sr-only">20%</span>
											</div>
										</div>
									</span>
								</li>
								<li class="data-row">
									<span class="data-name">Scheduled Report(s)</span>
									<span class="data-value">
										9 / 10 
										<div class="progress progress-xs">
											<div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100" style="width: 90%">
												<span class="sr-only">90%</span>
											</div>
										</div>
									</span>
								</li>
								<li class="data-row">
									<span class="data-name">Next License Renewal Date</span>
									<span class="data-value">1 Jan 2020</span>
								</li>
							</ul>
						</div>
						<!-- end sidebar content -->
					</div>
					<!-- end left sidebar -->
					<!-- top general alert -->
					<div class="alert alert-danger top-general-alert">
						<span>If you <strong>can't see the logo</strong> on the top left, please reset the style on right style switcher (for upgraded theme only).</span>
						<button type="button" class="close">&times;</button>
					</div>
					<!-- end top general alert -->
					<!-- content-wrapper -->
					<div class="col-md-10 content-wrapper expanded">
						<div class="row">
							<div class="col-md-4 ">
								<ul class="breadcrumb">
									<li><i class="fa fa-home"></i><a href="#">Home</a></li>
									<li class="active">Model</li>
									<li class="active">New Model</li>
								</ul>
							</div>
						</div>
						<!-- main -->
						<div class="content">
							<div class="main-header">
								<h2>New Simple Table Model</h2>
								<em>Creating a new logical data model for report datasource with simple table mapping</em>
							</div>
							<div class="main-content">
								<!-- WIDGET WIZARD -->
								<div class="widget">
									<div class="widget-header">
										<h3><i class="fa fa-table"></i> New Simple Table Model Wizard</h3>
									</div>
									<div class="widget-content">
										<div class="wizard-wrapper">
											<div id="model-wizard" class="wizard">
												<ul class="steps">
													<li data-target="#step1" class="active"><span class="badge badge-info">1</span>Model Name<span class="chevron"></span></li>
													<li data-target="#step2"><span class="badge">2</span>Data Source<span class="chevron"></span></li>
													<li data-target="#step3"><span class="badge">3</span>Table<span class="chevron"></span></li>
													<li data-target="#step4"><span class="badge">4</span>Attribute Mapping<span class="chevron"></span></li>
													<li data-target="#step5" class="last"><span class="badge">5</span>Create Model</li>
												</ul>
											</div>
											<div class="step-content">
												<!-- STEP 1 Model Name -->
												<div class="step-pane active" id="step1">
													<form id="form1" data-parsley-validate novalidate>
														<p>Please provide the follow details:</p>
														<div class="row">
															<div class="col-md-10">
																<div class="form-group">
																	<label for="modelName">Name *</label>
																	<input type="text" id="modelName" style="width:50%;" maxlength="45" class="form-control" data-parsley-length="[5,45]" required>
																</div>
																<div class="form-group">
																	<label for="modelDesc">Description</label>
																	<input type="text" id="modelDesc" class="form-control">
																</div>
															</div>
														</div>
													</form>
												</div>
												<!-- END STEP 1 -->
												<!-- STEP 2 Datasource -->
												<div class="step-pane" id="step2">
													<form id="form2" data-parsley-validate novalidate>
														<p>Please select data source for model</p>
														<div class="row">
															<div class="col-md-3">
																<label for="datasource">Datasource *</label>
																<select id="datasource" class="form-control" onchange="resetTableOption()" required></select>
															</div>
														</div>
													</form>
												</div>
												<!-- END STEP 2 -->
												<!-- STEP 3 Table -->
												<div class="step-pane" id="step3">
													<form id="form3" data-parsley-validate novalidate>
														<p>Please select table for model</p>
														<div class="row">
															<div class="col-md-3">
																<label for="modeltable">Table *</label>
																<select id="modeltable" class="form-control" onchange="resetAttributeMap()" required></select>
															</div>
														</div>
													</form>
												</div>
												<!-- END STEP 3 -->
												<!-- STEP 4 Attribute -->
												<div class="step-pane" id="step4">
													<form id="form4" data-parsley-validate novalidate>
														<p>Please define attribute(s) for model</p>
														<div class="row">
															<div class="col-md-6 widget-content">
																<!-- <label for="modelAttributes"></label> -->
																<div>
																	<table id="attrMapTable" class="table table-bordered table-striped">
																	</table>
																</div>
																<!-- this is required for parsley validation -->
																<input type="text" id="checkAttribute" style="display: none;" data-parsley-errors-container="#noCheckError"/>
																<p id="noCheckError"></p>
															</div>
														</div>
													</form>
												</div>
												<!-- END STEP 4 -->
												<!-- STEP 5 Confirmation -->
												<div class="step-pane" id="step5">
													<form id="form5">
														<div class="row">
															<div class="col-md-6 widget-content">
																<h4>
																	<i class="fa fa-square"></i>
																	Basic Information
																</h4>
																<p class="data-row">
																	<span class="data-name">Name</span>
																	<span id="finalModelName" class="data-value"></span>
																</p>
																<p class="data-row">
																	<span class="data-name">Description</span>
																	<span id="finalModelDesc" class="data-value"></span>
																</p>
																<p class="data-row">
																	<span class="data-name">Data Source</span>
																	<span id="finalDataSource" class="data-value"></span>
																</p>
																<p class="data-row">
																	<span class="data-name">Table</span>
																	<span id="finalTable" class="data-value"></span>
																</p>
															</div>
															<div class="col-md-6 widget-content">												
																<h4>
																	<i class="fa fa-square"></i>
																	Attribute(s) Information
																</h4>
																<p class="data-row">
																	<table id="attrFinalTable" class="table table-bordered table-striped">
																	</table>
																</p>
															</div>
														</div>
													</form>
												</div>
												<!-- END STEP 5 -->
											</div>
											<!-- STEP ACTION -->
											<div class="actions">
												<button type="button" class="btn btn-default btn-prev"><i class="fa fa-arrow-left"></i> Prev</button>
												<button type="button" class="btn btn-primary btn-next">Next <i class="fa fa-arrow-right"></i></button>
											</div>
											<!-- END STEP ACTION -->
										</div>
									</div>
								</div>
								
							</div>
							<!-- /main-content -->
						</div>
						<!-- /main -->
					</div>
					<!-- /content-wrapper -->
				</div>
				<!-- /row -->
			</div>
			<!-- /container -->
		</div>
		<!-- END BOTTOM: LEFT NAV AND RIGHT MAIN CONTENT -->
	</div>
	<!-- /wrapper -->

	<!-- FOOTER -->
	<footer class="footer">
		&copy; 2014-2015 The Develovers
	</footer>
	<!-- END FOOTER -->

	<!-- STYLE SWITCHER -->
	<div class="del-style-switcher">
		<div class="del-switcher-toggle toggle-hide"></div>
		<form>
			<section class="del-section del-section-skin">
				<h5 class="del-switcher-header">Choose Skins:</h5>
				<ul>
					<li><a href="#" title="Slate Gray" class="switch-skin slategray" data-skin="../../assets/css/skins/slategray.css">Slate Gray</a></li>
					<li><a href="#" title="Dark Blue" class="switch-skin darkblue" data-skin="../../assets/css/skins/darkblue.css">Dark Blue</a></li>
					<li><a href="#" title="Dark Brown" class="switch-skin darkbrown" data-skin="../../assets/css/skins/darkbrown.css">Dark Brown</a></li>
					<li><a href="#" title="Light Green" class="switch-skin lightgreen" data-skin="../../assets/css/skins/lightgreen.css">Light Green</a></li>
					<li><a href="#" title="Orange" class="switch-skin orange" data-skin="../../assets/css/skins/orange.css">Orange</a></li>
					<li><a href="#" title="Red" class="switch-skin red" data-skin="../../assets/css/skins/red.css">Red</a></li>
					<li><a href="#" title="Teal" class="switch-skin teal" data-skin="../../assets/css/skins/teal.css">Teal</a></li>
					<li><a href="#" title="Yellow" class="switch-skin yellow" data-skin="../../assets/css/skins/yellow.css">Yellow</a></li>
				</ul>
				<button type="button" class="switch-skin-full fulldark" data-skin="../../assets/css/skins/fulldark.css">Full Dark</button>
				<button type="button" class="switch-skin-full fullbright" data-skin="../../assets/css/skins/fullbright.css">Full Bright</button>
			</section>
			<label class="fancy-checkbox">
				<input type="checkbox" id="fixed-top-nav"><span>Fixed Top Navigation</span>
			</label>
			<p><a href="#" title="Reset Style" class="del-reset-style">Reset Style</a></p>
		</form>
	</div>
	<!-- END STYLE SWITCHER -->

	<!-- Javascript -->
	<script src="../../assets/js/jquery/jquery-2.1.0.min.js"></script>
	<script src="../../assets/js/bootstrap/bootstrap.js"></script>
	<script src="../../assets/js/plugins/modernizr/modernizr.js"></script>
	<script src="../../assets/js/plugins/bootstrap-tour/bootstrap-tour.custom.js"></script>
	<script src="../../assets/js/king-common.js"></script>
	<script src="../../demo-style-switcher/assets/js/deliswitch.js"></script>
	<script src="../../assets/js/plugins/bootstrap-switch/bootstrap-switch.min.js"></script>
	<script src="../../assets/js/plugins/raphael/raphael-2.1.0.min.js"></script>
	<script src="../../assets/js/plugins/jquery-sparkline/jquery.sparkline.min.js"></script>
	<script src="../../assets/js/plugins/datatable/jquery.dataTables.min.js"></script>
	<script src="../../assets/js/plugins/datatable/dataTables.bootstrap.js"></script>
	<script src="../../assets/js/plugins/jquery-mapael/jquery.mapael.js"></script>
	<script src="../../assets/js/plugins/parsley-validation/parsley.min.js"></script>
	<script src="../../assets/js/plugins/wizard/wizard.min.js"></script>
	<script src="../../assets/js/king-components.js"></script>
	
	<script type="text/javascript">
		var datasourceId;
		var tableIdx;
		var model;
		//AJAX functions
		var datasources
		var tables;
		var attributeMaps;

		var buildDataSourceOptions = function(){
			//jquery ajax
			$.ajax({
				type: "GET",
				url: "http://localhost:8080/reportbay-rest/api/datasources",
				
				success: function(response){
					if(response){
						datasources = response.datasources;
						
						if(datasources){
							$("#datasource").empty();
							
							var index;
							for(index = 0; index<datasources.length; index++){
								var datasource = datasources[index];
								
								$("#datasource").append($('<option></option>').val(datasource.id).html(datasource.name));
								
							}
						}
					}
				}
			});
		}
		
		var buildTableOptions = function(){
			//jquery ajax
			$.ajax({
				type: "GET",
				url: "http://localhost:8080/reportbay-rest/api/datasources/"+datasourceId+"/tables",
				
				success: function(response){
					if(response){
						tables = response.tables;
						
						if(tables){
							$("#modeltable").empty();
							
							var index;
							for(index = 0; index<tables.length; index++){
								var table = tables[index];
								
								$("#modeltable").append($('<option></option>').val(index).html(table.name));
								
							}
						}
					}
				}
			});
		} 
		
		var buildAttributeMap = function(){
			//jquery ajax
			$.ajax({
				type: "PUT",
				url: "http://localhost:8080/reportbay-rest/api/models/derivemodelattributes",
				data: JSON.stringify(model),
				contentType: "application/json",
				crossDomain: true,

				success: function(response){
					if(response){
						attributeMaps = response.attributeBindings;
						
						var tableDataSet = [];

						var index;
						
						var attrTab = $('#attrMapTable').DataTable({
							"destroy": true,
							paging : false,
							searching : false,
							info:false,
							"columns" : [
											{"title":"Enable", data:null, render: "enable"},
											{"title":"Table Field Name", data:null, render: "name"},
											{"title":"Model Attribute Name", data:null, render: "aliasInput"}]
						});
						
						//dynamically construct row
						for(index = 0; index<attributeMaps.length; index++){
							attrTab.row.add(new AttributeRow(index, attributeMaps[index].referencedColumn,attributeMaps[index].referencedColumn));
						}
						
						attrTab.draw();
						//*******************************************
						/*	SWITCH INIT Rendering
						/********************************************/
						$('.switch-reportbay').bootstrapSwitch();
					}
				}
			});
		}
		
		var createModel = function(){
			
			updateModelSelectedAttributes();
			
			//jquery ajax
			$.ajax({
				type: "POST",
				url: "http://localhost:8080/reportbay-rest/api/models",
				data: JSON.stringify(model),
				contentType: "application/json",
				crossDomain: true,

				success: function(response){
					alert('New model has been created.');
					window.location.assign("../model/model.html")
				},

				error: function(jqXHR, textStatus, ex){
					alert('Failed creation with error : '+textStatus+","+ex+","+jqXHR.responseText);
				}
			});
		}
		//End AJAX functions
		
		//reset table option on database change
		function resetTableOption(){
			tables = undefined;
		}
		//reset attribute map on table change
		function resetAttributeMap(){
			attributeMaps = undefined;
		}
		
		
		function constructAttributeMap(){
			var table = tables[tableIdx];
			
			if(table){
				//prepare REST request body
				model = {};
				model['id'] = '0';
				model['name']=$("#modelName").val();
				model['description']=$("#modelDesc").val();
				model['datasource'] = getDatasource();
				model['attributeBindings'] = new Array();
				var modelQuery = {'id':0, 'value':'','joinQuery':''};
				model['query']=modelQuery;
				model['table']=table.name;
				model['approach']='SINGLE_TABLE';
				
				//REST call
				buildAttributeMap();
			}
		}
		
		
		
		function AttributeRow(idx, name, alias){
			this._enable = "<input type='checkbox'  id='attr_"+idx+"' name='attr_"+name+"' checked class='switch-reportbay switch-mini' data-on='success' data-off='danger' data-on-label='<i class=&#39fa fa-check&#39></i>' data-off-label='<i class=&#39fa fa-remove&#39 style=&#39color:white;&#39></i>'>";
			this._name = name;
			this._alias_input = "<input type='text' id='alias_"+idx+"' value='"+alias+"' class='form-control'></input>";
			this._alias = alias;
			
			this.enable = function(){
				return this._enable;
			};
			this.name = function(){
				return this._name;
			};
			this.alias = function(){
				return this._alias;
			};
			this.aliasInput = function(){
				return this._alias_input;
			} 
		}
		
		function getDatasource(){
			
			var refDatasource;
			
			if(datasourceId && datasources){
				for(index = 0; index<datasources.length; index++){
					var tempDatasource = datasources[index];
					
					if(tempDatasource.id == datasourceId){
						refDatasource = tempDatasource;
						break;
					}
				}
			}
			
			return refDatasource;
		}
		
		//attribute validation
		function validateAttribute(){
			var checkCount = 0;
			var aliasExist = true;
			
			//clear all error message
			$("#form4").parsley().reset();
			
			//loop through the attribute row(s)
			for(index = 0; index<attributeMaps.length; index++){
				
				//if enabled
				if($("#attr_"+index).is(':checked')){
					checkCount++;
					
					//if alias field is empty for enabled row
					if($("#alias_"+index).val()==''){
						aliasExist = false;
						var failedAliasInput = $("#alias_"+index).parsley();

						//create custom parsley error message for affected field
						window.ParsleyUI.addError(failedAliasInput,"incompleteError"+index, "This field is required");
					}
				};
			}
			
			//no attribute row enabled
			if(checkCount==0){
				
				var checkError = $("#checkAttribute").parsley();
				//create custom parsley error message
				window.ParsleyUI.addError(checkError,"noCheckError", "At least one attribute must be enabled");
			}
			//at least 1 row enabled and all alias input value exist
			if(checkCount>0 && aliasExist){
				return true;
			}
			else{
				return false;
			}
		}
		
		function updateConfirmationDetail(){
			
			clearConfirmationDetail();

			$("#finalModelName").append($("#modelName").val());
			$("#finalModelDesc").append($("#modelDesc").val());
			$("#finalDataSource").append($("#datasource").find(":selected").text());
			$("#finalTable").append(tables[tableIdx].name);
			
			var attrTab = $('#attrFinalTable').DataTable({
				"destroy": true,
				paging : false,
				searching : false,
				ordering: false,
				info:false,
				"columns" : [
								{"title":"Table Field Name", data:null, render: "name"},
								{"title":"Model Attribute Name", data:null, render: "alias"}]
			});
			
			for(index = 0; index<attributeMaps.length; index++){
				
				if($("#attr_"+index).is(':checked')){
					attrTab.row.add(new AttributeRow(index, attributeMaps[index].referencedColumn,$("#alias_"+index).val()));
				};
			}
			
			attrTab.draw();
		}
		
		function clearConfirmationDetail(){
			$("#finalModelName").empty();
			$("#finalModelDesc").empty();
			$("#finalDatasource").empty();
			$("#finalTable").empty();
			
			$("#attrFinalTable").empty();
		}
		
		function updateModelSelectedAttributes(){
			//clear attribute array
			model['attributeBindings'].length=0;
			
			var newOrder = 1;
			for(index = 0; index<attributeMaps.length; index++){
				
				if($("#attr_"+index).is(':checked')){
					var attrMap = attributeMaps[index];
					attrMap.alias = $("#alias_"+index).val();
					attrMap.order = newOrder;

					newOrder ++;

					model['attributeBindings'].push(attrMap);
				}
			}
		}
		
		
		
		$(document).ready(function(){
	
			//model wizard function
			$('#model-wizard').on('change', function(e, data) {
				// validation
				if( $('#form'+data.step).length > 0 ) {
					var parsleyForm = $('#form'+data.step).parsley();
					parsleyForm.validate();
	
					if( !parsleyForm.isValid() )
						return false;
				}
	
				// last step button
				$btnNext = $(this).parents('.wizard-wrapper').find('.btn-next');
	
				if(data.step == 1 && data.direction == 'next' && !datasources){
					buildDataSourceOptions();
				}
				else if(data.step == 2 && data.direction == 'next' && !attributeMaps) {
					//obtain selected datasource id
					datasourceId = $("#datasource").find(":selected").val();
					
					if(datasourceId){
						buildTableOptions();
					}
				}
				else if(data.step == 3 && data.direction == 'next' && tables) {
					//obtain selected table index
					tableIdx = $("#modeltable").find(":selected").val();
					
					if(tableIdx){
						$("#attrMapTable").empty();
						constructAttributeMap();
					}
				}
				else if(data.step == 4 && data.direction == 'next') {
					
					//if failed attr validation
					if(!validateAttribute())
						return false;
					
					updateConfirmationDetail();

					$btnNext.text(' Create New Model')
					.prepend('<i class="fa fa-check-circle"></i>')
					.removeClass('btn-primary').addClass('btn-success');
				}else{
					$btnNext.text('Next ').
					append('<i class="fa fa-arrow-right"></i>')
					.removeClass('btn-success').addClass('btn-primary');
				}
	
			}).on('finished', function(){
				createModel();
			});
	
			$('.wizard-wrapper .btn-next').click( function(){
				$('#model-wizard').wizard('next');
			});
	
			$('.wizard-wrapper .btn-prev').click( function(){
				$('#model-wizard').wizard('previous');
			});
		});
	
	
	</script>
</body>

</html>
